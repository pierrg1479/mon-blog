---
// Support both PUBLIC_ and server-only GISCUS_* variables to avoid confusion.
const repo = import.meta.env.PUBLIC_GISCUS_REPO ?? import.meta.env.GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID ?? import.meta.env.GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY ?? import.meta.env.GISCUS_CATEGORY;
const categoryId =
        import.meta.env.PUBLIC_GISCUS_CATEGORY_ID ?? import.meta.env.GISCUS_CATEGORY_ID;

const giscusConfigured = repo && repoId && category && categoryId;
---
<section class="comments">
        {giscusConfigured ? (
                <div
                        class="commentsCard"
                        id="giscus-container"
                        data-repo={repo}
                        data-repo-id={repoId}
                        data-category={category}
                        data-category-id={categoryId}
                >
                        <span class="commentsTitle">Commentaires</span>
                        <div class="giscus-placeholder">Chargement des commentaires...</div>
                </div>
                <script>
                        // Lazy load Giscus when comments section is visible
                        let giscusLoaded = false;

                        const loadGiscus = () => {
                                if (giscusLoaded) return;
                                giscusLoaded = true;

                                const container = document.getElementById('giscus-container');
                                if (!container) return;

                                const placeholder = container.querySelector('.giscus-placeholder');
                                if (placeholder) placeholder.remove();

                                const isDark = document.documentElement.classList.contains('dark');
                                const theme = isDark ? 'dark_dimmed' : 'light';

                                const script = document.createElement('script');
                                script.src = 'https://giscus.app/client.js';
                                script.setAttribute('data-repo', container.dataset.repo);
                                script.setAttribute('data-repo-id', container.dataset.repoId);
                                script.setAttribute('data-category', container.dataset.category);
                                script.setAttribute('data-category-id', container.dataset.categoryId);
                                script.setAttribute('data-mapping', 'pathname');
                                script.setAttribute('data-strict', '1');
                                script.setAttribute('data-reactions-enabled', '1');
                                script.setAttribute('data-emit-metadata', '0');
                                script.setAttribute('data-input-position', 'bottom');
                                script.setAttribute('data-theme', theme);
                                script.setAttribute('data-lang', 'fr');
                                script.crossOrigin = 'anonymous';
                                script.async = true;
                                container.appendChild(script);

                                // Theme change observer
                                const themeObserver = new MutationObserver(() => {
                                        const iframe = document.querySelector('iframe.giscus-frame');
                                        if (iframe?.contentWindow) {
                                                const newTheme = document.documentElement.classList.contains('dark') ? 'dark_dimmed' : 'light';
                                                iframe.contentWindow.postMessage(
                                                        { giscus: { setConfig: { theme: newTheme } } },
                                                        'https://giscus.app'
                                                );
                                        }
                                });
                                themeObserver.observe(document.documentElement, {
                                        attributes: true,
                                        attributeFilter: ['class']
                                });
                        };

                        // Use IntersectionObserver to lazy load
                        if ('IntersectionObserver' in window) {
                                const observer = new IntersectionObserver((entries) => {
                                        entries.forEach(entry => {
                                                if (entry.isIntersecting) {
                                                        loadGiscus();
                                                        observer.disconnect();
                                                }
                                        });
                                }, { rootMargin: '200px' });

                                const container = document.getElementById('giscus-container');
                                if (container) observer.observe(container);
                        } else {
                                // Fallback for older browsers
                                setTimeout(loadGiscus, 3000);
                        }
                </script>
        ) : (
<p class="warning">Configurez Giscus via une seule s√©rie de variables d'environnement PUBLIC_GISCUS_* ou GISCUS_* pour activer les commentaires.</p>
        )}
</section>

<style>
        .comments {
                width: 720px;
                max-width: calc(100% - 2em);
                margin: 2em auto 0;
                padding: 1.5em 1em;
        }
        .commentsCard {
                margin-top: 2rem;
                padding: 1.25rem;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(255, 255, 255, 0.04);
        }
        :global(html:not(.dark)) .commentsCard {
                border-color: rgba(15, 23, 42, 0.12);
                background: rgba(15, 23, 42, 0.03);
        }
        .commentsTitle {
                display: block;
                margin: 0 0 1rem 0;
                font-size: 1.1rem;
                opacity: 0.9;
        }
        .warning {
                margin: 0;
                color: rgb(var(--accent));
        }
        .giscus-placeholder {
                padding: 2rem;
                text-align: center;
                color: rgb(var(--gray));
                font-size: 0.9rem;
        }
</style>
