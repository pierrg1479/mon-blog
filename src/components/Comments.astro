---
// Support both PUBLIC_ and server-only GISCUS_* variables to avoid confusion.
const repo = import.meta.env.PUBLIC_GISCUS_REPO ?? import.meta.env.GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID ?? import.meta.env.GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY ?? import.meta.env.GISCUS_CATEGORY;
const categoryId =
        import.meta.env.PUBLIC_GISCUS_CATEGORY_ID ?? import.meta.env.GISCUS_CATEGORY_ID;

const giscusConfigured = repo && repoId && category && categoryId;
---
<section class="comments">
        {giscusConfigured ? (
                <script
                        src="https://giscus.app/client.js"
                        data-repo={repo}
                        data-repo-id={repoId}
                        data-category={category}
                        data-category-id={categoryId}
                        data-mapping="pathname"
                        data-strict="1"
                        data-reactions-enabled="1"
                        data-emit-metadata="0"
                        data-input-position="bottom"
                        data-theme="https://theoptimizationguy.com/giscus-light.css"
                        data-lang="fr"
                        crossorigin="anonymous"
                        async>
                </script>
                <script is:inline>
                        function resolveGiscusThemeUrl() {
                                const htmlTheme = document.documentElement.getAttribute("data-theme");
                                const prefersDark = window.matchMedia("(prefers-color-scheme: dark)")
                                        .matches;
                                const theme = htmlTheme ?? (prefersDark ? "dark" : "light");
                                return theme === "dark"
                                        ? "https://theoptimizationguy.com/giscus-dark.css"
                                        : "https://theoptimizationguy.com/giscus-light.css";
                        }

                        function syncGiscusTheme() {
                                const themeUrl = resolveGiscusThemeUrl();
                                const iframe = document.querySelector("iframe.giscus-frame");

                                if (iframe) {
                                        iframe.contentWindow.postMessage(
                                                {
                                                        giscus: {
                                                                setConfig: {
                                                                        theme: themeUrl,
                                                                },
                                                        },
                                                },
                                                "https://giscus.app",
                                        );
                                }
                        }

                        const observer = new MutationObserver((mutations) => {
                                mutations.forEach((mutation) => {
                                        if (
                                                mutation.type === "attributes" &&
                                                mutation.attributeName === "data-theme"
                                        ) {
                                                syncGiscusTheme();
                                        }
                                });
                        });

                        observer.observe(document.documentElement, {
                                attributes: true,
                                attributeFilter: ["data-theme"],
                        });

                        window
                                .matchMedia("(prefers-color-scheme: dark)")
                                .addEventListener("change", syncGiscusTheme);

                        window.addEventListener("load", () => {
                                setTimeout(syncGiscusTheme, 1000);
                        });
                </script>
        ) : (
<p class="warning">Configurez Giscus via une seule s√©rie de variables d'environnement PUBLIC_GISCUS_* ou GISCUS_* pour activer les commentaires.</p>
        )}
</section>

<style>
        .comments {
                width: 720px;
                max-width: calc(100% - 2em);
                margin: 2em auto 0;
                padding: 1.5em 1em;
        }
        .warning {
                margin: 0;
                color: rgb(var(--accent));
        }
</style>
