---
// Composant pour ajouter une lightbox aux images - chargement différé pour performance
---

<script>
  // Import GLightbox depuis CDN - chargé à l'interaction pour meilleure performance
  let glightboxLoaded = false;
  let glightboxInstance = null;

  const loadGLightbox = async () => {
    if (glightboxLoaded) return;
    glightboxLoaded = true;

    // Charger le CSS
    if (!document.querySelector('link[href*="glightbox"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/css/glightbox.min.css';
      document.head.appendChild(link);
    }

    // Charger le JS
    if (!window.GLightbox) {
      await import('https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/js/glightbox.min.js');
    }

    // Sélectionner toutes les images dans l'article
    const images = document.querySelectorAll('article img');

    images.forEach((img) => {
      // Ne pas traiter les images déjà wrappées ou les avatars/logos
      if (img.closest('a') || img.classList.contains('no-lightbox')) {
        return;
      }

      // Créer un lien autour de l'image
      const link = document.createElement('a');
      link.href = img.src;
      link.classList.add('glightbox');
      link.setAttribute('data-gallery', 'article-images');

      // Ajouter le alt comme description si disponible
      if (img.alt) {
        link.setAttribute('data-glightbox', `description: ${img.alt}`);
      }

      // Wrapper l'image
      img.parentNode.insertBefore(link, img);
      link.appendChild(img);
    });

    // Initialiser GLightbox
    if (window.GLightbox) {
      glightboxInstance = window.GLightbox({
        touchNavigation: true,
        loop: true,
        autoplayVideos: false,
      });
    }
  };

  // Précharger GLightbox quand les images deviennent visibles ou au hover
  const setupLazyLoad = () => {
    const images = document.querySelectorAll('article img:not(.no-lightbox)');
    if (images.length === 0) return;

    // Observer pour charger quand les images sont visibles
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            // Précharger après un délai pour ne pas bloquer le rendu initial
            setTimeout(loadGLightbox, 100);
            observer.disconnect();
          }
        });
      }, { rootMargin: '200px' });

      images.forEach(img => observer.observe(img));
    } else {
      // Fallback: charger après un délai
      setTimeout(loadGLightbox, 3000);
    }

    // Charger aussi au premier hover sur une image
    images.forEach(img => {
      img.addEventListener('mouseenter', loadGLightbox, { once: true });
    });
  };

  // Attendre que le DOM soit prêt
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupLazyLoad);
  } else {
    setupLazyLoad();
  }
</script>

<style is:global>
  /* Ajouter un curseur pointer sur les images cliquables */
  article img:not(.no-lightbox) {
    cursor: zoom-in;
    transition: opacity 0.2s ease;
  }

  article img:not(.no-lightbox):hover {
    opacity: 0.9;
  }
</style>
