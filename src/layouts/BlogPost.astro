---
import { Image } from 'astro:assets';
import BaseHead from '../components/BaseHead.astro';
import AuthorBox from '../components/AuthorBox.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import Comments from '../components/Comments.astro';
import ShareButtons from '../components/ShareButtons.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import ArticleSchema from '../components/ArticleSchema.astro';
import ImageLightbox from '../components/ImageLightbox.astro';
import FormattedDate from '../components/FormattedDate.astro';
import '../styles/article-ultra-clean.css';
import '../styles/article-patch.css';

type AdjacentPost = {
	slug: string;
	title: string;
	h1?: string;
	pubDate: Date;
	heroImage?: string;
};

type Props = {
	h1?: string;
	title: string;
	description: string;
	pubDate: Date;
	updatedDate?: Date;
	heroImage?: any;
	content?: string;
	author?: any;
	previousPost?: AdjacentPost;
	nextPost?: AdjacentPost;
};

const {
	h1,
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	content,
	author,
	previousPost,
	nextPost,
} = Astro.props;

const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;
const displayTitle = h1 || title;

const heroImageSource = heroImage
	? typeof heroImage === 'string'
		? heroImage
		: heroImage.src
	: undefined;

const schemaImage = heroImageSource
	? heroImageSource.startsWith('http')
		? heroImageSource
		: new URL(heroImageSource, Astro.site).href
	: undefined;

const calculateReadingTime = (text: string): number => {
	const cleanText = text
		.replace(/```[\s\S]*?```/g, '')
		.replace(/`[^`]+`/g, '')
		.replace(/!\[.*?\]\(.*?\)/g, '')
		.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
		.replace(/[#*_~`]/g, '')
		.replace(/\s+/g, ' ')
		.trim();

	const words = cleanText ? cleanText.split(/\s+/).length : 0;
	const minutes = Math.ceil(words / 200);

	return Math.max(1, minutes);
};

const readingTime = calculateReadingTime(content);

const articleUrl = new URL(Astro.url.pathname, Astro.site || Astro.url.origin).href;
const prompt = `R√©sume cet article de mani√®re concise, en listant les points cl√©s √† retenir. Titre : ${displayTitle} ‚Äî URL : ${articleUrl}`;
const chatGPTUrl = `https://chat.openai.com/?q=${encodeURIComponent(prompt)}`;

const authorName = author?.name || 'Pierre';
const authorAvatar = author?.avatar
	? typeof author.avatar === 'string'
		? author.avatar
		: author.avatar.src
	: '/hannibal-cercle.png';
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImageSource} />
		<ArticleSchema
			title={title}
			headline={displayTitle}
			description={description}
			datePublished={pubDate}
			dateModified={updatedDate}
			image={schemaImage}
			canonicalUrl={canonicalUrl}
			author={author}
		/>
		<style>
			main {
				width: 100%;
				max-width: 100%;
				margin: 0 auto;
				padding: 0;
			}
			.hero-header {
				position: relative;
				height: 40vh;
				min-height: 400px;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: visible;
			}

			.hero-media {
				position: absolute;
				inset: 0;
				overflow: hidden;
				z-index: 1;
			}

			.hero-header-image {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
				z-index: 1;
			}

			.hero-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: linear-gradient(
					180deg,
					rgba(0, 0, 0, 0.3) 0%,
					rgba(0, 0, 0, 0.6) 100%
				);
				z-index: 2;
			}

			.hero-content {
				position: relative;
				z-index: 3;
				text-align: center;
				color: white;
				max-width: 800px;
				padding: 0 2rem;
			}

			.hero-title {
				font-size: clamp(2.5rem, 5vw, 4rem);
				font-weight: 800;
				margin: 0 0 1rem 0;
				color: #ffffff;
				text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
				line-height: 1.1;
			}

			.hero-meta {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 0.5rem;
				opacity: 0.95;
				text-shadow: 0 1px 10px rgba(0, 0, 0, 0.5);
			}

			.meta-info {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				font-size: 0.95rem;
				flex-wrap: wrap;
				justify-content: center;
			}

			.author-avatar {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				border: 2px solid rgba(255, 255, 255, 0.8);
				object-fit: cover;
			}

			.author-name {
				font-weight: 600;
			}

			.separator {
				opacity: 0.6;
			}

			.meta-date {
				color: rgba(255, 255, 255, 0.95) !important;
			}

			.dark .meta-date {
				color: rgba(255, 255, 255, 0.9) !important;
			}

			.ai-resume-badge {
				position: absolute;
				bottom: -1.25rem;
				left: 50%;
				transform: translateX(-50%);
				z-index: 10;
				background: white;
				color: #1a1a1a;
				padding: 0.6rem 1.25rem;
				border-radius: 50px;
				border: 1px solid rgba(0, 0, 0, 0.1);
				font-weight: 500;
				font-size: 0.85rem;
				cursor: pointer;
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				backdrop-filter: blur(10px);
				transition: all 0.3s ease;
				text-decoration: none;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
			}

			.ai-resume-badge:hover {
				background: #ffd04d;
				border-color: #ffd04d;
				transform: translateX(-50%) translateY(-2px);
				box-shadow: 0 4px 15px rgba(255, 208, 77, 0.3);
			}

			.ai-resume-badge:focus-visible {
				outline: 2px solid #ffd04d;
				outline-offset: 2px;
			}

			.ai-resume-icon {
				width: 16px;
				height: 16px;
				opacity: 0.7;
				flex-shrink: 0;
				display: block;
			}

			.ai-resume-badge:hover .ai-resume-icon {
				opacity: 1;
			}

			.article-content {
				background: white;
				margin: -2rem auto 0;
				position: relative;
				z-index: 5;
				max-width: 800px;
				padding: 3rem 2rem;
				border-radius: 1rem 1rem 0 0;
				box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
			}

			.dark .article-content {
				background: #0f172a;
				box-shadow: 0 -4px 30px rgba(15, 23, 42, 0.65);
			}

			@media (max-width: 768px) {
				.hero-header {
					height: 45vh;
					min-height: 380px;
				}

				.hero-header-image {
					object-position: center center;
				}

				.hero-title {
					font-size: clamp(1.75rem, 8vw, 2.5rem);
					padding: 0 1rem;
				}

				.hero-content {
					padding: 0 1.5rem;
				}

				.author-avatar {
					width: 28px;
					height: 28px;
				}

				.meta-info {
					font-size: 0.85rem;
				}

				.ai-resume-badge {
					bottom: -1.25rem;
					padding: 0.6rem 1.25rem;
					font-size: 0.85rem;
				}

				.article-content {
					margin: -2rem 1rem 0;
					padding: 2rem 1.5rem;
				}
			}

			@media (max-width: 480px) {
				.hero-title {
					font-size: 1.5rem;
					line-height: 1.2;
				}

				.hero-meta {
					flex-direction: column;
					gap: 0.5rem;
				}

				.meta-info {
					flex-direction: column;
					gap: 0.5rem;
					justify-content: center;
				}
			}

			.post-navigation {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
				gap: 1rem;
				margin: 3rem 0 1.5rem;
			}

			.nav-card {
				display: flex;
				flex-direction: column;
				gap: 1rem;
				padding: 1.5rem;
				border-radius: 16px;
				border: 1px solid rgba(15, 23, 42, 0.08);
				background: #f8fafc;
				color: inherit;
				text-decoration: none;
				box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
				transition: all 0.2s ease;
				align-items: stretch;
			}

			.nav-card:hover {
				border-color: rgba(15, 23, 42, 0.16);
				transform: translateY(-2px);
				box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
			}

			:global(.dark) .nav-card {
				background: #0b1221;
				border-color: rgba(255, 255, 255, 0.08);
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
			}

			:global(.dark) .nav-card:hover {
				border-color: rgba(255, 255, 255, 0.14);
				box-shadow: 0 12px 30px rgba(0, 0, 0, 0.55);
			}

			.nav-card.empty {
				opacity: 0.7;
				cursor: default;
				pointer-events: none;
			}

			.nav-content {
				display: flex;
				flex-direction: column;
				gap: 0.6rem;
				flex: 1;
				min-width: 0;
			}

			.nav-thumb {
				position: relative;
				width: 100%;
				aspect-ratio: 16 / 10;
				min-height: 140px;
				border-radius: 12px;
				overflow: hidden;
				flex-shrink: 0;
				background: #e2e8f0;
			}

			:global(.dark) .nav-thumb {
				background: #1e293b;
			}

			.nav-thumb img {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
				object-position: center top;
				margin: 0;
				box-shadow: none;
				display: block;
			}

			.nav-direction {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				font-weight: 600;
				color: #0f172a;
				opacity: 0.8;
			}

			:global(.dark) .nav-direction {
				color: #e2e8f0;
			}

			.nav-direction.next {
				justify-content: flex-end;
				text-align: right;
			}

			.nav-title {
				display: block;
				margin: 0;
				font-size: 1.15rem;
				color: #0f172a;
			}

			:global(.dark) .nav-title {
				color: #f8fafc;
			}

			.nav-meta {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				color: #475569;
			}

			:global(.dark) .nav-meta {
				color: #cbd5e1;
			}

			.nav-empty-text {
				margin: 0;
				color: #94a3b8;
			}

			:global(.dark) .nav-empty-text {
				color: #94a3b8;
			}
		</style>
	</head>

	<body>
		<ReadingProgress />
		<Header />
		<main>
			<article>
				<div class="hero-header">
					<div class="hero-media">
						{heroImage && (
							<Image
								width={1600}
								height={900}
								src={heroImage}
								alt={displayTitle}
								class="hero-header-image"
								loading="eager"
								fetchpriority="high"
								format="webp"
								quality={85}
								/>
							)}
							<div class="hero-overlay"></div>
						</div>
						<div class="hero-content">
						<h1 class="hero-title">{displayTitle}</h1>
						<div class="hero-meta">
							<div class="meta-info">
								<img
									src={authorAvatar}
									alt={authorName}
									class="author-avatar no-lightbox"
									loading="lazy"
								/>
								<span class="author-name">{authorName}</span>
								<span class="separator" aria-hidden="true">¬∑</span>
								<span class="meta-date">
									Publi√© le{' '}
									<FormattedDate date={pubDate} />
									{updatedDate && updatedDate.getTime() !== pubDate.getTime() && (
										<>
											{' ‚Ä¢ Mis √† jour le '}
											<FormattedDate date={updatedDate} />
										</>
									)}
								</span>
								<span class="separator" aria-hidden="true">¬∑</span>
								<span>{readingTime} min de lecture</span>
							</div>
						</div>
					</div>
					<a
						class="ai-resume-badge"
						href={chatGPTUrl}
						target="_blank"
						rel="noopener noreferrer"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							class="ai-resume-icon"
						>
							<path d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5L12 2z" />
							<path d="M19 13l.9 2.7L22 16l-2.1.3L19 19l-.9-2.7L16 16l2.1-.3L19 13z" />
							<path d="M5 13l.9 2.7L8 16l-2.1.3L5 19l-.9-2.7L2 16l2.1-.3L5 13z" />
						</svg>
						R√©sum√© IA
					</a>
				</div>

		<div class="article-content">
					<div class="prose">
						<slot />
						<ShareButtons title={displayTitle} />
						<AuthorBox />
						<Comments />
						{(previousPost || nextPost) && (
							<section class="post-navigation" aria-label="Navigation entre articles">
								{previousPost ? (
									<a class="nav-card" href={`/blog/${previousPost.slug}/`}>
										{previousPost.heroImage && (
											<div class="nav-thumb" aria-hidden="true">
												<img
													src={previousPost.heroImage}
													alt={`Illustration de ${previousPost.h1 ?? previousPost.title}`}
													loading="lazy"
												/>
											</div>
										)}
										<div class="nav-content">
											<div class="nav-direction">
												<span aria-hidden="true">‚Üê</span>
												<span class="direction-label">Article pr√©c√©dent</span>
											</div>
											<span class="nav-title">{previousPost.h1 ?? previousPost.title}</span>
											<div class="nav-meta">
												<span aria-hidden="true">üìÖ</span>
												<FormattedDate date={previousPost.pubDate} />
											</div>
										</div>
									</a>
								) : (
									<div class="nav-card empty">
										<div class="nav-content">
											<div class="nav-direction">
												<span aria-hidden="true">‚Üê</span>
												<span class="direction-label">Pas d'article pr√©c√©dent</span>
											</div>
											<p class="nav-empty-text">Vous √™tes sur le premier article.</p>
										</div>
									</div>
								)}

								{nextPost ? (
									<a class="nav-card" href={`/blog/${nextPost.slug}/`}>
										{nextPost.heroImage && (
											<div class="nav-thumb" aria-hidden="true">
												<img
													src={nextPost.heroImage}
													alt={`Illustration de ${nextPost.h1 ?? nextPost.title}`}
													loading="lazy"
												/>
											</div>
										)}
										<div class="nav-content">
											<div class="nav-direction next">
												<span class="direction-label">Article suivant</span>
												<span aria-hidden="true">‚Üí</span>
											</div>
											<span class="nav-title">{nextPost.h1 ?? nextPost.title}</span>
											<div class="nav-meta">
												<span aria-hidden="true">üìÖ</span>
												<FormattedDate date={nextPost.pubDate} />
											</div>
										</div>
									</a>
								) : (
									<div class="nav-card empty">
										<div class="nav-content">
											<div class="nav-direction next">
												<span class="direction-label">Pas d'article suivant</span>
												<span aria-hidden="true">‚Üí</span>
											</div>
											<p class="nav-empty-text">Vous √™tes sur le dernier article.</p>
										</div>
									</div>
								)}
							</section>
						)}
					</div>
				</div>
			</article>
		</main>
		<Footer />
		<ImageLightbox />
		<!-- Deferred TOC generation script -->
		<script>
			// G√©n√©ration automatique du sommaire - diff√©r√©e pour performance
			const initTOC = () => {
				const article = document.querySelector('.prose');
				if (!article) return;

				const headings = Array.from(article.querySelectorAll('h2, h3, h4')).filter(
					heading => !heading.closest('.author-box, .comments')
				);
				if (headings.length === 0) return;

				const toc = document.createElement('details');
				toc.className = 'toc';

				const summary = document.createElement('summary');
				summary.textContent = 'Sommaire';
				toc.appendChild(summary);

				const tocContent = document.createElement('div');
				tocContent.className = 'toc-content';

				const tocList = document.createElement('ul');
				tocList.className = 'toc-list';

				headings.forEach((heading, index) => {
					if (!heading.id) {
						const headingText = heading.textContent
							.toLowerCase()
							.replace(/[^a-z0-9]+/g, '-')
							.replace(/(^-|-$)/g, '');
						heading.id = headingText || `heading-${index}`;
					}

					const li = document.createElement('li');
					li.className = `toc-${heading.tagName.toLowerCase()}`;

					const link = document.createElement('a');
					link.href = `#${heading.id}`;
					link.textContent = heading.textContent;

					link.addEventListener('click', function(e) {
						e.preventDefault();
						heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
						history.pushState(null, null, `#${heading.id}`);
					});

					li.appendChild(link);
					tocList.appendChild(li);
				});

				tocContent.appendChild(tocList);
				toc.appendChild(tocContent);

				const titleBlock = article.querySelector('.title');
				if (titleBlock) {
					titleBlock.after(toc);
				} else {
					article.insertBefore(toc, article.firstChild);
				}
			};

			// Utiliser requestIdleCallback si disponible, sinon setTimeout
			if ('requestIdleCallback' in window) {
				requestIdleCallback(initTOC);
			} else {
				setTimeout(initTOC, 0);
			}
		</script>

		<!-- Google Tag Manager - Deferred loading for better performance -->
		<script is:inline>
			// Load GTM after page is interactive
			const loadGTM = () => {
				const gtmScript = document.createElement('script');
				gtmScript.async = true;
				gtmScript.src = 'https://www.googletagmanager.com/gtm.js?id=GTM-PTBBTWQV';
				document.head.appendChild(gtmScript);
				window.dataLayer = window.dataLayer || [];
				window.dataLayer.push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
			};
			if ('requestIdleCallback' in window) {
				requestIdleCallback(loadGTM, { timeout: 3000 });
			} else {
				setTimeout(loadGTM, 2000);
			}
		</script>
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PTBBTWQV" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	</body>
</html>
