---
import { Image } from 'astro:assets';
import BaseHead from '../components/BaseHead.astro';
import AuthorBox from '../components/AuthorBox.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import Comments from '../components/Comments.astro';
import ShareButtons from '../components/ShareButtons.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import ArticleSchema from '../components/ArticleSchema.astro';
import ImageLightbox from '../components/ImageLightbox.astro';
import FormattedDate from '../components/FormattedDate.astro';
import '../styles/article-ultra-clean.css';
import '../styles/article-patch.css';

type Props = {
	title: string;
	description: string;
	pubDate: Date;
	updatedDate?: Date;
	heroImage?: any;
	content?: string;
	author?: any;
};

const { title, description, pubDate, updatedDate, heroImage, content, author } = Astro.props;

const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;

const heroImageSource = heroImage
	? typeof heroImage === 'string'
		? heroImage
		: heroImage.src
	: undefined;

const schemaImage = heroImageSource
	? heroImageSource.startsWith('http')
		? heroImageSource
		: new URL(heroImageSource, Astro.site).href
	: undefined;

const calculateReadingTime = (text: string): number => {
	const cleanText = text
		.replace(/```[\s\S]*?```/g, '')
		.replace(/`[^`]+`/g, '')
		.replace(/!\[.*?\]\(.*?\)/g, '')
		.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
		.replace(/[#*_~`]/g, '')
		.replace(/\s+/g, ' ')
		.trim();

	const words = cleanText ? cleanText.split(/\s+/).length : 0;
	const minutes = Math.ceil(words / 200);

	return Math.max(1, minutes);
};

const readingTime = calculateReadingTime(content);

const articleUrl = new URL(Astro.url.pathname, Astro.site || Astro.url.origin).href;
const prompt = `Résume cet article de manière concise, en listant les points clés à retenir. Titre : ${title} — URL : ${articleUrl}`;
const chatGPTUrl = `https://chat.openai.com/?q=${encodeURIComponent(prompt)}`;

const authorName = author?.name || 'Pierre';
const authorAvatar = author?.avatar
	? typeof author.avatar === 'string'
		? author.avatar
		: author.avatar.src
	: '/hannibal-cercle.png';
---

<html lang="en">
	<head>
		<!-- Google Tag Manager -->
		<script is:inline>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({
					'gtm.start': new Date().getTime(),
					event: 'gtm.js',
				});
				const f = d.getElementsByTagName(s)[0];
				const j = d.createElement(s);
				const dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, 'script', 'dataLayer', 'GTM-PTBBTWQV');
		</script>
		<!-- End Google Tag Manager -->
		<BaseHead title={title} description={description} />
		<ArticleSchema
			title={title}
			description={description}
			datePublished={pubDate}
			dateModified={updatedDate}
			image={schemaImage}
			canonicalUrl={canonicalUrl}
			author={author}
		/>
		<link rel="stylesheet" href="/src/styles/article-ultra-clean.css" />
		<link rel="stylesheet" href="/src/styles/article-patch.css" />
		<style>
			main {
				width: 100%;
				max-width: 100%;
				margin: 0 auto;
				padding: 0;
			}
			.hero-header {
				position: relative;
				height: 40vh;
				min-height: 400px;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: visible;
			}

			.hero-media {
				position: absolute;
				inset: 0;
				overflow: hidden;
				z-index: 1;
			}

			.hero-header-image {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
				z-index: 1;
			}

			.hero-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: linear-gradient(
					180deg,
					rgba(0, 0, 0, 0.3) 0%,
					rgba(0, 0, 0, 0.6) 100%
				);
				z-index: 2;
			}

			.hero-content {
				position: relative;
				z-index: 3;
				text-align: center;
				color: white;
				max-width: 800px;
				padding: 0 2rem;
			}

			.hero-title {
				font-size: clamp(2.5rem, 5vw, 4rem);
				font-weight: 800;
				margin: 0 0 1rem 0;
				color: #ffffff;
				text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
				line-height: 1.1;
			}

			.hero-meta {
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 0.5rem;
				opacity: 0.95;
				text-shadow: 0 1px 10px rgba(0, 0, 0, 0.5);
			}

			.meta-info {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				font-size: 0.95rem;
				flex-wrap: wrap;
				justify-content: center;
			}

			.author-avatar {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				border: 2px solid rgba(255, 255, 255, 0.8);
				object-fit: cover;
			}

			.author-name {
				font-weight: 600;
			}

			.separator {
				opacity: 0.6;
			}

			.date {
				display: inline-flex;
				align-items: center;
				margin-bottom: 1rem;
				color: rgb(var(--gray));
				font-size: 0.95rem;
			}

			.updated {
				color: rgb(var(--gray-light));
				font-style: italic;
			}

			.ai-resume-badge {
				position: absolute;
				bottom: -1.25rem;
				left: 50%;
				transform: translateX(-50%);
				z-index: 10;
				background: white;
				color: #1a1a1a;
				padding: 0.6rem 1.25rem;
				border-radius: 50px;
				border: 1px solid rgba(0, 0, 0, 0.1);
				font-weight: 500;
				font-size: 0.85rem;
				cursor: pointer;
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				backdrop-filter: blur(10px);
				transition: all 0.3s ease;
				text-decoration: none;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
			}

			.ai-resume-badge:hover {
				background: #ffd04d;
				border-color: #ffd04d;
				transform: translateX(-50%) translateY(-2px);
				box-shadow: 0 4px 15px rgba(255, 208, 77, 0.3);
			}

			.ai-resume-badge:focus-visible {
				outline: 2px solid #ffd04d;
				outline-offset: 2px;
			}

			.ai-resume-icon {
				width: 16px;
				height: 16px;
				opacity: 0.7;
				flex-shrink: 0;
				display: block;
			}

			.ai-resume-badge:hover .ai-resume-icon {
				opacity: 1;
			}

			.article-content {
				background: white;
				margin: -2rem auto 0;
				position: relative;
				z-index: 5;
				max-width: 800px;
				padding: 3rem 2rem;
				border-radius: 1rem 1rem 0 0;
				box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
			}

			.dark .article-content {
				background: #0f172a;
				box-shadow: 0 -4px 30px rgba(15, 23, 42, 0.65);
			}

			@media (max-width: 768px) {
				.hero-header {
					height: 45vh;
					min-height: 380px;
				}

				.hero-header-image {
					object-position: center center;
				}

				.hero-title {
					font-size: clamp(1.75rem, 8vw, 2.5rem);
					padding: 0 1rem;
				}

				.hero-content {
					padding: 0 1.5rem;
				}

				.author-avatar {
					width: 28px;
					height: 28px;
				}

				.meta-info {
					font-size: 0.85rem;
				}

				.ai-resume-badge {
					bottom: -1.25rem;
					padding: 0.6rem 1.25rem;
					font-size: 0.85rem;
				}

				.article-content {
					margin: -2rem 1rem 0;
					padding: 2rem 1.5rem;
				}
			}

			@media (max-width: 480px) {
				.hero-title {
					font-size: 1.5rem;
					line-height: 1.2;
				}

				.hero-meta {
					flex-direction: column;
					gap: 0.5rem;
				}

				.meta-info {
					flex-direction: column;
					gap: 0.5rem;
					justify-content: center;
				}
			}
		</style>
	</head>

	<body>
		<!-- Google Tag Manager (noscript) -->
		<noscript
			><iframe
				src="https://www.googletagmanager.com/ns.html?id=GTM-PTBBTWQV"
				height="0"
				width="0"
				style="display:none;visibility:hidden"></iframe
		></noscript>
		<!-- End Google Tag Manager (noscript) -->
		<ReadingProgress />
		<Header />
		<main>
			<article>
				<div class="hero-header">
					<div class="hero-media">
						{heroImage && (
							<Image
								width={1600}
								height={900}
								src={heroImage}
								alt={title}
								class="hero-header-image"
								loading="eager"
							/>
						)}
						<div class="hero-overlay"></div>
					</div>
					<div class="hero-content">
						<h1 class="hero-title">{title}</h1>
						<div class="hero-meta">
							<div class="meta-info">
								<img
									src={authorAvatar}
									alt={authorName}
									class="author-avatar no-lightbox"
									loading="lazy"
								/>
								<span class="author-name">{authorName}</span>
									<span class="separator" aria-hidden="true">
										·
									</span>
									<div class="date">
										Publié le <FormattedDate date={pubDate} />
										{updatedDate && updatedDate.getTime() !== pubDate.getTime() && (
											<span> • Mis à jour le <FormattedDate date={updatedDate} /></span>
										)}
									</div>
									<span class="separator" aria-hidden="true">
										·
									</span>
								<span>{readingTime} min de lecture</span>
							</div>
						</div>
					</div>
					<a
						class="ai-resume-badge"
						href={chatGPTUrl}
						target="_blank"
						rel="noopener noreferrer"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2"
							stroke-linecap="round"
							stroke-linejoin="round"
							class="ai-resume-icon"
						>
							<path d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5L12 2z" />
							<path d="M19 13l.9 2.7L22 16l-2.1.3L19 19l-.9-2.7L16 16l2.1-.3L19 13z" />
							<path d="M5 13l.9 2.7L8 16l-2.1.3L5 19l-.9-2.7L2 16l2.1-.3L5 13z" />
						</svg>
						Résumé IA
					</a>
				</div>

				<div class="article-content">
					<div class="prose">
						<slot />
						<ShareButtons title={title} />
						<AuthorBox />
						<Comments />
					</div>
				</div>
			</article>
		</main>
		<Footer />
		<ImageLightbox />
		<script>
			// Génération automatique du sommaire
			document.addEventListener('DOMContentLoaded', function() {
				const article = document.querySelector('.prose');
				if (!article) return;

				const headings = Array.from(article.querySelectorAll('h2, h3, h4')).filter(
					heading => !heading.closest('.author-box, .comments')
				);
				if (headings.length === 0) return;

				const toc = document.createElement('details');
				toc.className = 'toc';

				const summary = document.createElement('summary');
				summary.textContent = 'Sommaire';
				toc.appendChild(summary);

				const tocContent = document.createElement('div');
				tocContent.className = 'toc-content';

				const tocList = document.createElement('ul');
				tocList.className = 'toc-list';

				headings.forEach((heading, index) => {
					if (!heading.id) {
						const headingText = heading.textContent
							.toLowerCase()
							.replace(/[^a-z0-9]+/g, '-')
							.replace(/(^-|-$)/g, '');
						heading.id = headingText || `heading-${index}`;
					}

					const li = document.createElement('li');
					li.className = `toc-${heading.tagName.toLowerCase()}`;

					const link = document.createElement('a');
					link.href = `#${heading.id}`;
					link.textContent = heading.textContent;

					link.addEventListener('click', function(e) {
						e.preventDefault();
						heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
						history.pushState(null, null, `#${heading.id}`);
					});

					li.appendChild(link);
					tocList.appendChild(li);
				});

				tocContent.appendChild(tocList);
				toc.appendChild(tocContent);

				const titleBlock = article.querySelector('.title');
				if (titleBlock) {
					titleBlock.after(toc);
				} else {
					article.insertBefore(toc, article.firstChild);
				}
			});
		</script>
	</body>
</html>
